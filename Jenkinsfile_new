pipeline {
    agent any

    environment {
        IMAGE_NAME = 'jmeterfile'  // Your Docker image name
        TEST_REPO = 'https://github.com/Hari-svg/Jmeter_jenkins.git'  // Your GitHub repo URL
    }

    stages {
        stage('Checkout Tests') {
            steps {
                // Clone your test scripts repository with credentials
                git branch: 'main', credentialsId: "${params.gitCredentialsID}", url: "${TEST_REPO}"
            }
        }
        
        stage('Run JMeter Tests') {
            steps {
                // Use bat instead of sh and adjust volume mount for Windows PowerShell syntax
                bat """
                docker run --rm -v "%WORKSPACE%:/tests" ^ ${IMAGE_NAME} ^
                /opt/apache-jmeter-5.5/bin/jmeter ^ -n -t PrometheusListener.jmx -l results.jtl
                """
            }
        }

        stage('Archive Results') {
            steps {
                archiveArtifacts artifacts: 'results.jtl', fingerprint: true
            }
        }
    }
}
